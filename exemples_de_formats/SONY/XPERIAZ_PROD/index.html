<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SONY XperiaZ</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<link rel="stylesheet" href="css/styles.css" type="text/css">
<script type="text/javascript">

var _s4mq = _s4mq || [];
try { sasSupportsClick = true; } catch(e) { }

var CLICKURL = "http://www.sonymobile.com/fr/products/phones/xperia-z/";


var shaken = false;
var elapsed = 0;
var step = 0;
var ox = new Array();
var oy = new Array(); 
var dx = new Array();
var dy = new Array();
var wave1Timer = 6;
var wave2Timer = 10;
var buttonTimer = 2;
var arrowTimer = 0.7;
var finalAngle = -30;
var upTimer = 0.4;
var phoneTop = 110;
var downWaterTop = 300;
var upWaterTop = 20;
var bullesTop = 93;

if (typeof $ === 'undefined') {
	$ = function(id){
		return document.getElementById(id);
	};
}

window.addEventListener('load', function(){
	preload();
});

function scale( id,x,y) {
	document.getElementById(id).style.width = parseInt(x*coef)+"px";
	document.getElementById(id).style.height = parseInt(y*coef)+"px";
}

function scale2( id,x,y) {
	document.getElementById(id).style.width = parseInt(x*coef2)+"px";
	document.getElementById(id).style.height = parseInt(y*coef2)+"px";
}

function scalePosLT( id,x,y) {
	document.getElementById(id).style.left = parseInt(x*coef)+"px";
	document.getElementById(id).style.top = parseInt(y*coef)+"px";
}

function scalePosRT( id,x,y) {
	document.getElementById(id).style.right = parseInt(x*coef)+"px";
	document.getElementById(id).style.top = parseInt(y*coef)+"px";
}

function scalePosLT2( id,x,y) {
	document.getElementById(id).style.left = parseInt(x*coef2)+"px";
	document.getElementById(id).style.top = parseInt(y*coef2)+"px";
}

function center(id) {
	document.getElementById(id).style.left = parseInt((window.innerWidth - document.getElementById(id).offsetWidth) / 2)+"px";
}

preload = function() {
		
		console.log("preload");
		$('loader').style.width = window.innerWidth+"px";
		$('loader').style.height = window.innerHeight+"px";		
		var images = new Array();		
		images.push("images/XperiaZ_TestVague_04.jpg");
		images.push("images/XperiaZ_TestVague_05.jpg");
		images.push("images/Main_Full_01.jpg");
		images.push("images/Main_Full_02.png");
		images.push("images/Phone_1b.jpg");
		images.push("images/Phone_03.jpg");
		images.push("images/LogoSony.png");
		images.push("images/LogoXperiaZ.png");
		images.push("images/Bouton.png");
		images.push("images/Bouton_Reflet2.png");	
		images.push("images/Fleche.jpg");
		images.push("images/FooterGris.jpg");	
		images.push("images/Drops_Phone.jpg");
		
		var imagesLoadedNumber = 0;
		if ( images.length == 0 ) {
			init();
		} else {
			for(var i=0; i<images.length; i++)
			{
				var image = new Image();
				image.onload = function(){
					imagesLoadedNumber++;
					console.log("imagesLoadedNumber = "+imagesLoadedNumber);
					if(imagesLoadedNumber == images.length)
					{
						console.log("Loaded");
						document.getElementById("loader").style.display = "none";
						init();
					}
				}
				image.onerror = function(){
					imagesLoadedNumber++;
					console.log("imagesLoadedNumber = "+imagesLoadedNumber);
					if(imagesLoadedNumber == images.length)
					{
						console.log("Loaded");
						document.getElementById("loader").style.display = "none";
						init();
					}
				}
				image.src = images[i];
			}
		}
}


function goTimer() {

	elapsed++;	
	switch (elapsed) {
		case 4 : gotoStep1(); break;	
		default: break;
	}
	setTimeout( goTimer, 1000);
}

function gotoStep1() {
	
	if ( step < 1) {
		step = 1;
		$('osez').style.display = 'none';
		$('fleche').style.display = 'none';
	
		$('liquide').style.webkitTransitionDuration = upTimer+"s";
		$('liquide').style.webkitTransitionTimingFunction =  'ease-in';
		$('liquide').style.top = upWaterTop+'px';
	
		$('mainBack').style.webkitTransitionDuration = "0.5s";
		$('mainBack').style.top = '-200px';
		$('mainBack').style.opacity = '0';
		$('mainBack').style.webkitTransitionTimingFunction =  'linear';
	
		$('mainFront').style.webkitTransitionDuration = "0.5s";
		$('mainFront').style.top = '-200px';
		$('mainFront').style.opacity = '0';
		$('mainFront').style.webkitTransitionTimingFunction =  'linear';
	
		$('phoneContainer').style.webkitTransform = "rotate("+(parseInt(""+finalAngle+""))+"deg)";
		$('phoneContainer').style.webkitTransformOrigin = "10% 20%";
		$('phoneContainer').style.top = phoneTop+"px";
		$('phoneContainer').style.webkitTransitionTimingFunction =  'ease-out';
		$('phoneContainer').style.webkitTransition = "all 500ms";
		
		setTimeout( showBulles, (upTimer*1000));
		setTimeout( ring, 2000);
	}
}

function showBulles () {
	$('bulles').style.display = 'block';
	setTimeout(bulleEffectGo, 1);
}

function ring() {
	try {
		mraid.vibrate();
	} catch (e) {};
	$('phoneContainer').style.backgroundImage =  'url("images/Phone_03.jpg")';
}

function init() {

	 $('loader').style.display = 'none';
	 $('centered').style.display = 'block';
	 
	resize();

	setTimeout( goTimer, 1000);
	
	 setTimeout( vagueEffectGo, 1);
	 setTimeout( vague2EffectGo, 1);
	 setTimeout( flecheEffectGo, 1);
 	 setTimeout(btnEffectGo, 200);
 	 
 	 
 	// touch event
 	document.addEventListener('touchmove',function(e) {
		e.preventDefault();
	},false);
	
	function touchStart(event) {	
		var touch = event.touches[0];
	    ox[event.target] = touch.pageX;
	    oy[event.target] = touch.pageY; 
	    dx[event.target] = 0;
	    dy[event.target] = 0;	    
	}
	
	
	function touchMove(event) {
		event.preventDefault();
		var touch = event.touches[0];
	    dx[event.target] = touch.pageX - ox[event.target];
	    dy[event.target] = touch.pageY - oy[event.target];    
	}
	
	function touchEnd(event) {
		
	    if(!event.targetTouches.length){	
	    		var diff = dy[event.target];
	    		
	    		if ( diff > 0) {
					//on a tiré en bas
					if ( step == 0) {
						_s4mq.push(['trackAction', {name: "played"}]);
						gotoStep1();
					} else {
						doClick();
					}	
				}					
	    }
	}
 	
 	$('wrapper').addEventListener('touchstart', touchStart , false);
	$('wrapper').addEventListener('touchmove', touchMove , false);
	$('wrapper').addEventListener('touchend', touchEnd , false);
 
	 // device motion Detect
	 
	 window.ondevicemotion = function(e) {  
	    var accelerationX = e.accelerationIncludingGravity.x;  
	    var accelerationY = e.accelerationIncludingGravity.y;  
	    var accelerationZ = e.accelerationIncludingGravity.z;
	    
	    var landscapeOrientation=window.innerWidth/window.innerHeight>1;
	
	    var angle = 0;
	    if ( landscapeOrientation) {
	    	if ( accelerationX <0) {
	    		angle =  180 * ( Math.atan2(accelerationX, accelerationY) / Math.PI ) + 90;
	    	} else {
	    		angle =  180 * ( Math.atan2(-accelerationX, -accelerationY) / Math.PI ) + 90;
	    	}
	    
	    } else {
	    	if ( accelerationY <0) {
	    		angle =  180 * ( Math.atan2(accelerationY, -accelerationX) / Math.PI ) + 90;
	    	} else {
	    		angle =  180 * ( Math.atan2(-accelerationY, accelerationX) / Math.PI ) + 90;
	    	}
	    }
	    
		if ( angle > 180) angle = -90;
		if ( angle > 90 ) angle = 90;
		
		var angle1 = angle;
		if ( angle1 > 20 ) angle1 = 20;
		if ( angle1 < -20 ) angle1 = -20;
		
		var angle2 = parseInt(0.2*angle -10);
		if ( angle2 > -8 ) angle2 = -8;
		if ( angle2 < -16 ) angle2 = -16;
		
		
		if (( accelerationZ < -8) || ( accelerationZ > 8)) {
			angle1 = 0;
			angle2 = -10;
			angle3 = -30;
			angle = 0;
		}
		
		$('liquide').style.webkitTransform = "rotate("+(parseInt(""+angle1+""))+"deg)";
		$('liquide').style.webkitTransformOrigin = "50% 0";
		$('liquide').style.webkitTransition = "all 400ms";
	
		if ( step == 0 ) {
			$('phoneContainer').style.webkitTransform = "rotate("+(parseInt(angle2))+"deg)";
			$('phoneContainer').style.webkitTransformOrigin = "18% 7%";
			$('phoneContainer').style.webkitTransition = "all 500ms";
			
			$('mainFront').style.webkitTransform = "rotate("+(parseInt(angle2+15))+"deg)";
			$('mainFront').style.webkitTransformOrigin = "70% 10%";
			$('mainFront').style.webkitTransition = "all 500ms";
			
			$('mainBack').style.webkitTransform = "rotate("+(parseInt(angle2+15))+"deg)";
			$('mainBack').style.webkitTransformOrigin = "70% 10%";
			$('mainBack').style.webkitTransition = "all 500ms";
		} else {
			$('phoneContainer').style.marginLeft = parseInt(-angle*0.6)+"px";
			$('phoneContainer').style.webkitTransitionTimingFunction =  'ease-in-out';
			$('phoneContainer').style.webkitTransition = "all 500ms";
			$('bulles').style.marginLeft = parseInt(-angle*0.8)+"px";
		}
	}
}

btnEffectBack = function() {
	$('boutonReflet').style.webkitTransitionDuration = "0.0s";
	$('boutonReflet').style.backgroundPosition = '-142px 0';
	setTimeout( btnEffectGo, 1000);
}

btnEffectGo = function() {
	$('boutonReflet').style.webkitTransitionDuration = "2.0s";
	$('boutonReflet').style.backgroundPosition = '142px 0';
	setTimeout( btnEffectBack, 2000);	
} 

// haut vague
vagueEffectGo = function() {
	$('vague').style.webkitTransitionDuration = parseInt(wave1Timer)+"s";
	//$('vague').style.backgroundPosition = '-694px 0,0 0';
	$('vague').style.backgroundPosition = parseInt(-694*coef2)+'px 0,0 0';
	$('vague').style.webkitTransitionTimingFunction =  'linear';
	setTimeout( vagueEffectBack, parseInt(wave1Timer*1000) );
}

vagueEffectBack = function() {
	$('vague').style.webkitTransitionDuration = "0.0s";
	$('vague').style.backgroundPosition = '0px 0,0 0';
	setTimeout( vagueEffectGo, 0);
}

// bas vague
vague2EffectGo = function() {
	$('vague2').style.webkitTransitionDuration = parseInt(wave2Timer)+"s";
	$('vague2').style.backgroundPosition = parseInt(-694*coef2)+'px 0,0 0';
	$('vague2').style.webkitTransitionTimingFunction =  'linear';
	setTimeout( vague2EffectBack, parseInt(wave2Timer*1000));
}

vague2EffectBack = function() {
	$('vague2').style.webkitTransitionDuration = "0.0s";
	$('vague2').style.backgroundPosition = '0px 0,0 0';
	setTimeout( vague2EffectGo, 0);
}

// scroll bulles
bulleEffectGo = function() {
	$('bulles').style.webkitTransitionDuration = parseInt(wave2Timer)+"s";
	$('bulles').style.backgroundPosition = '0 '+parseInt(-233*coef)+'px';
	$('bulles').style.webkitTransitionTimingFunction =  'linear';
	setTimeout( bulleEffectBack, parseInt(wave2Timer*1000));
}

bulleEffectBack = function() {
	$('bulles').style.webkitTransitionDuration = "0.0s";
	$('bulles').style.backgroundPosition = '0 0';
	setTimeout( bulleEffectGo, 0);
}

// fleche movement
flecheEffectGo = function() {
	$('fleche').style.webkitTransitionDuration = arrowTimer+"s";
	$('fleche').style.marginTop = parseInt(40*coef)+'px';
	$('fleche').style.opacity = '0';
	$('fleche').style.webkitTransitionTimingFunction =  'linear';
	setTimeout( flecheEffectBack, parseInt(arrowTimer*1000));
}

flecheEffectBack = function() {
	$('fleche').style.webkitTransitionDuration = "0.0s";
	$('fleche').style.marginTop = '0px';
	$('fleche').style.opacity = '1';
	setTimeout( flecheEffectGo, 0);
}

function resize() {

	coef = 1;
	coef2 = 1;
	//
	if ( (window.innerWidth > 320) || ( window.innerHeight < 480) ){
		coef = window.innerHeight/480;
		coef2 = 0.65 * window.innerWidth/320;
	} 
	
	$('centered').style.width = parseInt(320*coef)+"px";
	
	scale('mainFront', 335,131);
	scalePosLT( 'mainFront', -184, -10);
	scale('mainBack', 335,131);
	scalePosLT( 'mainBack', -184, -10);
	
	scale('phoneContainer', 140,266);
	scalePosLT( 'phoneContainer', 60, 34);
	
	scale('fleche', 27,27);
	scalePosLT( 'fleche', 30, 230);
	
	scale('osez', 90,50);
	scalePosLT('osez', 0,180);
	$('osez').style.lineHeight = parseInt(50*coef)+'px';
	$('osez').style.fontSize = parseInt(22*coef)+'px';
		
	scale('logoSony', 87,28);
	scalePosRT( 'logoSony', 10, 90);
	
	scale('liquide', 320,468);		
	scale('bulles', 232,233);
	scalePosLT( 'bulles', 44, 133);		
	scale2('vague', 694, 46);
	scalePosLT2( 'vague', -155, 0);
	scale2('vague2', 694, 46);
	scalePosLT2( 'vague2', -155, 46);
		
	downWaterTop = parseInt(window.innerHeight - 178 *coef);
	
	phoneTop = parseInt(110*coef );
	if ( window.innerHeight > 460) {
		phoneTop = parseInt(110 + (window.innerHeight - 460)/2);
	}
	
	bullesTop = phoneTop-17;
		
	if ( step == 0 )  {
		$('liquide').style.top = downWaterTop+'px';
	} else {
		$('phoneContainer').style.top = phoneTop+"px";
	}
	
	$('bulles').style.top = parseInt(bullesTop)+"px"; 
	
	center('centered');
	center('logoXperia');
	center('bouton');
	center('mension');
}

// Click sur le telephone
function doClick2() {
	
	if ( step == 0 ) {
		// le tel n'est pas encore dans l'eau : il tombe (on considere un slide down)
		_s4mq.push(['trackAction', {name: "played"}]);
		gotoStep1();
	} else {
		// le tel est deja dans l'eau : on clique
		doClick();
	}
}


function doClick() {

	/* CASE 1 : LANDING PAGE DEFINED WITH S4M TRACKING SYSTEM */
	/* USE ONLY IF AD SDK IS ABLE TO INTERCEPT <A> LINKS AND DISPLAY INTO EXTERNAL BROWSER */
	/* SMART 3.2.x IOS SYSTEM IS ONE OF THEM*/
	//try { 
	//	_s4mq.push(['getClickUrl', function(url){
	//			if ( url === undefined) url = CLICKURL;
    //            var alink = document.createElement('a');
	//			  alink.href = CLICKURL;
	//			  alink.click();
    //	}]);
    //} catch (e) { }
	
	/* CASE 2 : LANDING PAGE DEFINED BY ADSERVER WITH MRAID SYSTEM */
	//try { 
	//	mraid.click();
	//} catch (e) { }
	
	/* CASE 3 : LANDING PAGE DEFINED BY ADSERVER WITH OLD SMART SYSTEM */
	//try { 
	//	document.location.href = "sas:click";
	//} catch (e) { }
	
	/* CASE 4 : LANDING PAGE DEFINED BY ADSERVER WITH SMART 3.2.x IOS SYSTEM */
	try { 
		
		var alink = document.createElement('a');
		alink.href = CLICKURL;
		alink.click();

	} catch (e) { }
	
}
</script>


<script type="text/javascript">
  _s4mq.push(['trackDisplay']);
 
  (function() {
   var s4mScript = document.createElement('script'); s4mScript.type = 'text/javascript'; s4mScript.async = true;
   s4mScript.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'eu-adstatic.sam4m.com/analytics/js/ad/s4m.js';
   var s4mElement = document.getElementsByTagName('script')[0]; s4mElement.parentNode.insertBefore(s4mScript, s4mElement);
  })();
</script>
</head>
<body onresize="resize();">
	<div id="loader">
		<div id="imgLoaderContainer" >
			<div id="imgLoader" ></div>
		</div>
	</div>
	<div id="wrapper">
		<div id="centered" >
			<div id="mainBack" onClick="gotoStep1();"></div>
			<div id="mainFront" onClick="gotoStep1();"></div>
			<div id="liquide">
				<div id="vague"></div>
				<div id="vague2"></div>
				<div id="bulles"></div>
			</div>
			<div id="osez">Osez !</div>
			<div id="fleche" onClick="gotoStep1();"></div>
			<div id="phoneContainer" onClick="doClick2();"></div>
		</div>
		<div id="logoSony"></div>
		<div id="footer" >
			<div id="logoXperia"></div>
			<div id="bouton" onClick="doClick();">
				<div id="boutonReflet" onClick="doClick();"></div>
			</div>
			<div id="mension">IP 55/57 : 30 minutes max. à 1 mètre de profondeur</div>
		</div>
    </div>
</body>
</html>